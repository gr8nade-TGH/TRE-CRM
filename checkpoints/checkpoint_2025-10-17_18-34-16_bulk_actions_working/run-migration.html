<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRE CRM - Run Database Migration</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }
        .section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            border: 1px solid #dee2e6;
            max-height: 400px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        button.secondary {
            background: #2196F3;
        }
        button.secondary:hover {
            background: #0b7dda;
        }
        .step {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-left: 4px solid #4CAF50;
        }
        .step h3 {
            margin-top: 0;
        }
        code {
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <h1>üöÄ TRE CRM - Database Migration</h1>
    
    <div class="section">
        <h2>üìã Migration Instructions</h2>
        <p>This migration will create the following tables:</p>
        <ul>
            <li><strong>lead_notes</strong> - Internal notes on leads</li>
            <li><strong>specials</strong> - Promotional specials and offers</li>
            <li><strong>documents</strong> - Document tracking</li>
        </ul>
        
        <div class="status warning">
            ‚ö†Ô∏è <strong>Note:</strong> The anon key cannot execute DDL statements (CREATE TABLE). 
            You need to run this in the Supabase SQL Editor.
        </div>
    </div>

    <div class="section">
        <h2>üéØ Option 1: Copy SQL to Supabase (Recommended)</h2>
        
        <div class="step">
            <h3>Step 1: Copy the SQL</h3>
            <button onclick="copySQLToClipboard()">üìã Copy SQL to Clipboard</button>
            <div id="copyStatus"></div>
        </div>

        <div class="step">
            <h3>Step 2: Open Supabase SQL Editor</h3>
            <button class="secondary" onclick="openSupabaseSQLEditor()">üîó Open Supabase SQL Editor</button>
            <p>Or manually go to: <code>https://supabase.com/dashboard/project/mevirooooypfjbsrmzrk/sql/new</code></p>
        </div>

        <div class="step">
            <h3>Step 3: Paste and Run</h3>
            <ol>
                <li>Paste the SQL into the editor</li>
                <li>Click the <strong>"Run"</strong> button</li>
                <li>Wait for success message</li>
            </ol>
        </div>

        <div class="step">
            <h3>Step 4: Verify Tables Created</h3>
            <button onclick="window.location.href='check-database.html'">‚úÖ Check Database Schema</button>
        </div>
    </div>

    <div class="section">
        <h2>üìÑ SQL Migration Script</h2>
        <pre id="sqlContent">Loading SQL...</pre>
    </div>

    <script>
        const SQL_CONTENT = `-- ============================================================================
-- TRE CRM - Create Missing Tables
-- ============================================================================

-- 1. LEAD_NOTES TABLE
CREATE TABLE IF NOT EXISTS public.lead_notes (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    lead_id VARCHAR NOT NULL REFERENCES public.leads(id) ON DELETE CASCADE,
    content TEXT NOT NULL,
    author_id VARCHAR NOT NULL REFERENCES public.users(id),
    author_name VARCHAR NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_lead_notes_lead_id ON public.lead_notes(lead_id);
CREATE INDEX IF NOT EXISTS idx_lead_notes_created_at ON public.lead_notes(created_at);
CREATE INDEX IF NOT EXISTS idx_lead_notes_author_id ON public.lead_notes(author_id);

ALTER TABLE public.lead_notes ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view notes for their assigned leads" ON public.lead_notes
    FOR SELECT USING (
        EXISTS (
            SELECT 1 FROM public.leads 
            WHERE leads.id = lead_notes.lead_id 
            AND (leads.assigned_agent_id = auth.uid()::text OR
                 EXISTS (
                     SELECT 1 FROM public.users 
                     WHERE users.id = auth.uid()::text 
                     AND users.role IN ('MANAGER', 'SUPER_USER')
                 ))
        )
    );

CREATE POLICY "Users can insert notes for their assigned leads" ON public.lead_notes
    FOR INSERT WITH CHECK (
        EXISTS (
            SELECT 1 FROM public.leads 
            WHERE leads.id = lead_notes.lead_id 
            AND (leads.assigned_agent_id = auth.uid()::text OR
                 EXISTS (
                     SELECT 1 FROM public.users 
                     WHERE users.id = auth.uid()::text 
                     AND users.role IN ('MANAGER', 'SUPER_USER')
                 ))
        )
    );

CREATE POLICY "Users can update their own notes" ON public.lead_notes
    FOR UPDATE USING (author_id = auth.uid()::text);

CREATE POLICY "Managers can update any notes" ON public.lead_notes
    FOR UPDATE USING (
        EXISTS (
            SELECT 1 FROM public.users 
            WHERE users.id = auth.uid()::text 
            AND users.role IN ('MANAGER', 'SUPER_USER')
        )
    );

GRANT SELECT, INSERT, UPDATE ON public.lead_notes TO authenticated;

-- 2. SPECIALS TABLE
CREATE TABLE IF NOT EXISTS public.specials (
    id VARCHAR PRIMARY KEY,
    property_id VARCHAR REFERENCES public.properties(id) ON DELETE CASCADE,
    property_name VARCHAR NOT NULL,
    market VARCHAR NOT NULL,
    title VARCHAR NOT NULL,
    description TEXT NOT NULL,
    valid_from DATE NOT NULL,
    valid_until DATE NOT NULL,
    active BOOLEAN DEFAULT true,
    featured BOOLEAN DEFAULT false,
    terms TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_specials_property_id ON public.specials(property_id);
CREATE INDEX IF NOT EXISTS idx_specials_market ON public.specials(market);
CREATE INDEX IF NOT EXISTS idx_specials_active ON public.specials(active);
CREATE INDEX IF NOT EXISTS idx_specials_valid_until ON public.specials(valid_until);

ALTER TABLE public.specials ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Anyone can view active specials" ON public.specials
    FOR SELECT USING (active = true);

CREATE POLICY "Managers can view all specials" ON public.specials
    FOR SELECT USING (
        EXISTS (
            SELECT 1 FROM public.users 
            WHERE users.id = auth.uid()::text 
            AND users.role IN ('MANAGER', 'SUPER_USER')
        )
    );

CREATE POLICY "Managers can insert specials" ON public.specials
    FOR INSERT WITH CHECK (
        EXISTS (
            SELECT 1 FROM public.users 
            WHERE users.id = auth.uid()::text 
            AND users.role IN ('MANAGER', 'SUPER_USER')
        )
    );

CREATE POLICY "Managers can update specials" ON public.specials
    FOR UPDATE USING (
        EXISTS (
            SELECT 1 FROM public.users 
            WHERE users.id = auth.uid()::text 
            AND users.role IN ('MANAGER', 'SUPER_USER')
        )
    );

CREATE POLICY "Managers can delete specials" ON public.specials
    FOR DELETE USING (
        EXISTS (
            SELECT 1 FROM public.users 
            WHERE users.id = auth.uid()::text 
            AND users.role IN ('MANAGER', 'SUPER_USER')
        )
    );

GRANT SELECT ON public.specials TO anon;
GRANT SELECT, INSERT, UPDATE, DELETE ON public.specials TO authenticated;

-- 3. DOCUMENTS TABLE
CREATE TABLE IF NOT EXISTS public.documents (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    lead_id VARCHAR REFERENCES public.leads(id) ON DELETE CASCADE,
    name VARCHAR NOT NULL,
    type VARCHAR NOT NULL,
    status VARCHAR NOT NULL DEFAULT 'pending',
    url VARCHAR,
    notes TEXT,
    uploaded_by VARCHAR REFERENCES public.users(id),
    uploaded_at TIMESTAMP WITH TIME ZONE,
    reviewed_by VARCHAR REFERENCES public.users(id),
    reviewed_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_documents_lead_id ON public.documents(lead_id);
CREATE INDEX IF NOT EXISTS idx_documents_status ON public.documents(status);
CREATE INDEX IF NOT EXISTS idx_documents_type ON public.documents(type);

ALTER TABLE public.documents ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view documents for their assigned leads" ON public.documents
    FOR SELECT USING (
        EXISTS (
            SELECT 1 FROM public.leads 
            WHERE leads.id = documents.lead_id 
            AND (leads.assigned_agent_id = auth.uid()::text OR
                 EXISTS (
                     SELECT 1 FROM public.users 
                     WHERE users.id = auth.uid()::text 
                     AND users.role IN ('MANAGER', 'SUPER_USER')
                 ))
        )
    );

CREATE POLICY "Users can insert documents" ON public.documents
    FOR INSERT WITH CHECK (
        EXISTS (
            SELECT 1 FROM public.leads 
            WHERE leads.id = documents.lead_id 
            AND (leads.assigned_agent_id = auth.uid()::text OR
                 EXISTS (
                     SELECT 1 FROM public.users 
                     WHERE users.id = auth.uid()::text 
                     AND users.role IN ('MANAGER', 'SUPER_USER')
                 ))
        )
    );

CREATE POLICY "Users can update documents" ON public.documents
    FOR UPDATE USING (
        EXISTS (
            SELECT 1 FROM public.leads 
            WHERE leads.id = documents.lead_id 
            AND (leads.assigned_agent_id = auth.uid()::text OR
                 EXISTS (
                     SELECT 1 FROM public.users 
                     WHERE users.id = auth.uid()::text 
                     AND users.role IN ('MANAGER', 'SUPER_USER')
                 ))
        )
    );

GRANT SELECT, INSERT, UPDATE ON public.documents TO authenticated;

-- 4. TRIGGERS
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_lead_notes_updated_at 
    BEFORE UPDATE ON public.lead_notes 
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_specials_updated_at 
    BEFORE UPDATE ON public.specials 
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_documents_updated_at 
    BEFORE UPDATE ON public.documents 
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- 5. ENABLE REALTIME
ALTER PUBLICATION supabase_realtime ADD TABLE public.lead_notes;
ALTER PUBLICATION supabase_realtime ADD TABLE public.specials;
ALTER PUBLICATION supabase_realtime ADD TABLE public.documents;
`;

        // Display SQL content
        document.getElementById('sqlContent').textContent = SQL_CONTENT;

        // Copy SQL to clipboard
        function copySQLToClipboard() {
            navigator.clipboard.writeText(SQL_CONTENT).then(() => {
                const statusDiv = document.getElementById('copyStatus');
                statusDiv.innerHTML = '<div class="status success" style="margin-top: 10px;">‚úÖ SQL copied to clipboard!</div>';
                setTimeout(() => {
                    statusDiv.innerHTML = '';
                }, 3000);
            }).catch(err => {
                const statusDiv = document.getElementById('copyStatus');
                statusDiv.innerHTML = '<div class="status error" style="margin-top: 10px;">‚ùå Failed to copy: ' + err.message + '</div>';
            });
        }

        // Open Supabase SQL Editor
        function openSupabaseSQLEditor() {
            window.open('https://supabase.com/dashboard/project/mevirooooypfjbsrmzrk/sql/new', '_blank');
        }
    </script>
</body>
</html>

