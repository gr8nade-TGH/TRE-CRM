<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Texas Relocation Experts â€” Manager Console (v5)</title>
<link rel="preconnect" href="https://unpkg.com">
<link rel="preconnect" href="https://tile.openstreetmap.org">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<style>
  :root{
    --bg:#f6f7f9;
    --panel:#ffffff;
    --ink:#0b1020;
    --muted:#6b7280;
    --rule:#d9dde3;
    --brand:#153e7a;      /* TRE blue */
    --brand-2:#c62828;    /* TRE red  */
    --shadow:0 10px 30px rgba(10,10,10,.06);
    --green:#25d366;
    --yellow:#ffd84d;
    --red:#ff3b30;
  }
  *,*::before,*::after{box-sizing:border-box}
  html,body{height:100%}
  body{ margin:0; font:16px/1.35 system-ui,-apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial, sans-serif; color:var(--ink); background:var(--bg); }
  /* === Brand bar === */
  .brandbar{
    position:sticky; top:0; z-index:1200;
    display:flex; align-items:center; gap:16px;
    padding:8px 16px; background:#0b1220; color:#fff;
    box-shadow:0 6px 18px rgba(0,0,0,.18);
  }
  .brandwrap{ display:flex; align-items:center; gap:14px; }
  .brand-logo{ height:44px; display:block; }
  .brand-logo.hide{ display:none; }
  .brand-text{ font-weight:900; letter-spacing:.02em; font-size:20px; }
  .brand-text.hide{ display:none; }
  .brandspacer{ flex:1; }
  .envbadge{ font-weight:800; background:#1e3a8a; border:1px solid rgba(255,255,255,.2); padding:6px 10px; border-radius:999px; }
  .banner{ display:none; } /* superseded by brandbar */

  .layout{ width:min(1380px,96vw); margin:20px auto 40px; display:grid; grid-template-columns: 220px 1fr; gap:24px; align-items:start; }
  .sidebar{ padding-top:6px; }
  .nav{ list-style:none; padding:0; margin:0; }
  .nav li{ letter-spacing:.02em; margin:14px 0; color:#111; cursor:pointer; user-select:none;}
  .nav li.active{ font-size:42px; font-weight:800; color:var(--brand); }
  .nav li:not(.active){ font-size:30px; font-weight:800; color:#1f2937; }

  .panel{ background:var(--panel); border:1px solid var(--rule); border-radius:26px; padding:26px 26px 34px; position:relative; box-shadow:var(--shadow); }

  /* Hover row for datagrids */
  table.datagrid tbody tr:hover{ background:#fafbff; }
  .hidden{display:none !important}

  /* Legend for Leads */
  .legend{ position:absolute; top:14px; right:18px; display:flex; align-items:center; gap:10px; font-weight:700; flex-wrap:wrap; max-width:48%; justify-content:flex-end; }
  .dot{ width:18px;height:18px;border-radius:50%; display:inline-block;border:2px solid #0b0b0b22; box-shadow:inset 0 1px 0 rgba(255,255,255,.6); }
  .dot.green{background:var(--green)} .dot.yellow{background:var(--yellow)} .dot.red{background:var(--red)}
  .legend .desc{margin-left:6px; white-space:nowrap; font-weight:800}
  .legend .legend-item{display:flex; align-items:center; gap:8px; padding:2px 8px; border:1px dashed transparent; border-radius:999px;}
  .legend .legend-item:hover{ background:#f3f4f6; border-color:#e5e7eb; }

  /* Data tables (fixed alignment) */
  table.datagrid{ width:100%; border-collapse:separate; border-spacing:0; table-layout:fixed; }
  .panel .datagrid thead th{ position:sticky; top:0; background:#fff; z-index:1; }
  table.datagrid thead th{ text-align:left; font-size:15px; font-weight:800; color:#111; padding:12px 14px 12px 12px; border-bottom:2px solid var(--rule); }
  table.datagrid tbody td{ padding:12px 14px 12px 12px; border-bottom:1px solid var(--rule); vertical-align:middle; font-size:18px; font-weight:800; }
  /* column widths */
  .col-name{width:260px}
  .col-view{width:110px}
  .col-health{width:56px}
  .col-date{width:130px}
  .col-summary{width:380px}
  .col-options{width:120px}
  .col-action{width:100px}
  .col-assign{width:220px}

  .col-num{width:110px} /* agent metrics */
  .col-money{width:150px}

  /* Buttons & icons */
  .eye-btn{ width:44px;height:32px;display:inline-flex;align-items:center;justify-content:center; border:2px solid var(--rule); border-radius:18px;background:#fafafa; cursor:pointer; transition:.15s ease transform,.15s ease background; }
  .eye-btn:hover{ background:#f0f3f7; transform:translateY(-1px) }
  .eye{ width:22px;height:22px; }
  .doc-btn{ width:46px;height:36px;display:inline-flex;align-items:center;justify-content:center; border:2px solid var(--rule);border-radius:8px;background:#fbfbfb;cursor:pointer; transition:.15s ease transform,.15s ease background; }
  .doc-btn:hover{ background:#f0f3f7; transform:translateY(-1px)}
  .doc{ width:18px;height:22px; }
  .action-btn{ width:38px;height:34px;display:inline-flex;align-items:center;justify-content:center; border:2px solid var(--rule); border-radius:10px; background:#fff; cursor:pointer; }
  .action-btn:hover{ background:#f0f3f7; }

  /* Health icons */
  .health-btn{ border:0; background:transparent; padding:0; cursor:pointer; }
  .health-dot{ width:18px;height:18px;border-radius:50%; border:2px solid #0b0b0b22; display:inline-block; box-shadow:inset 0 1px 0 rgba(255,255,255,.6); }
  .health-green{ background:var(--green) } .health-yellow{ background:var(--yellow) } .health-red{ background:var(--red) }
  .health-icon{ width:20px;height:20px;border-radius:50%;border:2px solid #0b0b0b22; display:inline-flex; align-items:center; justify-content:center; background:#fff; }
  .health-icon svg{ width:14px;height:14px; } .health-check svg{ stroke:#10b981; stroke-width:3; fill:none;} .health-lost svg{ stroke:#ef4444; stroke-width:3; fill:none;}

  /* Fake select input */
  .assign{ position:relative; display:flex; align-items:center; }
  .assign input{ width:100%; padding:10px 36px 10px 12px; border:2px solid #cfd5df; border-radius:10px;background:#fff; font-size:16px;font-weight:700; color:#0b1324; }
  .assign .caret{ position:absolute; right:12px; pointer-events:none; width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;border-top:8px solid #9aa3b2; }

  .tag{ display:inline-flex; align-items:center; border:1px solid #cfd5df; border-radius:999px; padding:4px 10px; font-weight:800; background:#f8fafc; }

  .sr-only{position:absolute;left:-9999px}

  /* ---------- Modal ---------- */
  .modal{ position:fixed; inset:0; display:none; background:rgba(15,23,42,.48); backdrop-filter:saturate(130%) blur(2px); z-index:2000; }
  .modal.open{ display:grid; place-items:center; }
  .modal-box{ width:min(1100px,92vw); background:#fff; border-radius:18px; border:1px solid var(--rule); box-shadow:0 30px 70px rgba(0,0,0,.25); overflow:hidden; max-height:88vh; display:flex; flex-direction:column; }
  .modal-header{ display:flex; align-items:center; justify-content:space-between; padding:16px 18px; border-bottom:1px solid var(--rule); background:#f8fbff; }
  .modal-header .title{ font-size:20px; font-weight:800; }
  .modal-close{ border:0; background:#fff; border:1px solid var(--rule); width:36px; height:36px; border-radius:10px; cursor:pointer; }
  .modal-body{ padding:16px 18px; overflow:auto; }

  /* Forms grid */
  .grid{ display:grid; gap:14px; }
  .grid.cols-2{ grid-template-columns: 1fr 1fr; } .grid.cols-3{ grid-template-columns: repeat(3,1fr); }
  label{ display:block; font-size:13px; color:#374151; margin-bottom:6px; }
  input[type="text"], input[type="email"], input[type="tel"], select, textarea{ width:100%; padding:10px 12px; border:1.8px solid #cfd5df; border-radius:8px; background:#fff; font-size:14px; }
  textarea{ min-height:90px; resize:vertical; }

  /* Snackbar */
  .snackbar{ position:fixed; left:50%; transform:translateX(-50%); bottom:20px; background:#111827; color:#fff; padding:10px 14px; border-radius:10px; opacity:0; pointer-events:none; transition:.25s ease opacity, .25s ease transform; z-index:3000; }
  .snackbar.show{ opacity:1; pointer-events:auto; transform:translateX(-50%) translateY(-4px); }
  .snackbar[role="status"]{ aria-live:polite; }

  /* Filters */
  .filters{ display:flex; gap:10px; align-items:flex-end; padding:10px 0 14px; margin-top:8px; border-bottom:1px solid var(--rule); }
  .filters .field{ display:grid; gap:6px; }
  .filters label{ font-size:12px; color:#4b5563; }
  .filters input[type="text"], .filters input[type="date"], .filters select{ padding:8px 10px; border:1.8px solid #cfd5df; border-radius:8px; font-size:14px; min-width:160px; }
  .filters .spacer{ flex:1; }
  .filters .btn{ padding:8px 12px; border-radius:10px; border:1px solid #cfd5df; background:#fff; cursor:pointer; font-weight:700; }
  .filters .btn:hover{ background:#f3f4f6; }

  /* Popover for health details */
  .popover{ position:fixed; z-index:2500; background:#fff; border:1px solid #e5e7eb; border-radius:12px; box-shadow:0 20px 40px rgba(0,0,0,.18); padding:10px 12px; width:280px; }
  .popover h4{ margin:0 0 6px; font-size:14px; color:#111827; }
  .popover ul{ margin:0; padding-left:18px; }
  .popover li{ font-size:14px; color:#374151; margin:4px 0; }
  .popover .small{ color:#6b7280; font-size:12px; margin-top:6px; }
  .arrow{ position:absolute; width:0; height:0; border-left:8px solid transparent; border-right:8px solid transparent; border-bottom:8px solid #e5e7eb; top:-8px; left:18px; }
  .arrow::after{ content:""; position:absolute; top:1px; left:-7px; width:0; height:0; border-left:7px solid transparent; border-right:7px solid transparent; border-bottom:7px solid #fff; }

  /* ---------- LISTINGS PAGE ---------- */
  .listings-layout{ display:grid; grid-template-columns: 58% 42%; gap:14px; }
  .mapwrap{ border:1px solid var(--rule); border-radius:12px; overflow:hidden; min-height:560px; }
  #listingsMap{ width:100%; height:100%; min-height:560px; }
  .price-marker{ background:#0f172a; color:#fff; font-weight:800; padding:6px 8px; border-radius:999px; border:2px solid #fff; box-shadow:0 2px 6px rgba(0,0,0,.25); white-space:nowrap; }
  .listing-table{ width:100%; border-collapse:separate; border-spacing:0; }
  .listing-table thead th{ text-align:left; font-size:13px; font-weight:800; color:#111; padding:10px 8px; border-bottom:2px solid var(--rule); }
  .listing-table tbody td{ padding:10px 8px; border-bottom:1px solid var(--rule); vertical-align:middle; font-size:14px; font-weight:700; color:#111827;}
  .badge{ display:inline-block; padding:2px 6px; border-radius:999px; background:#eef2ff; color:var(--brand); font-weight:800; font-size:12px; margin-right:6px; }
  .table-scroller{ max-height:560px; overflow:auto; border:1px solid var(--rule); border-radius:12px; }
  .muted{ color:#6b7280; font-weight:600; }

  /* Action menu */
  .menu{ position:fixed; z-index:2600; background:#fff; border:1px solid #e5e7eb; border-radius:12px; box-shadow:0 20px 40px rgba(0,0,0,.18); padding:6px; width:260px; display:none; }
  .menu.open{ display:block; }
  .menu button{ width:100%; background:#fff; border:0; text-align:left; padding:10px 10px; border-radius:8px; cursor:pointer; font-weight:700; }
  .menu button:hover{ background:#f3f4f6; }
  .menu .danger{ color:#b91c1c; }

  /* Keyboard focus visuals */
  :focus-visible{ outline:3px solid #2563eb; outline-offset:2px; }

  @media (prefers-reduced-motion: reduce){
    *{ transition:none !important; animation:none !important; }
  }
  @media (max-width: 1100px){
    .listings-layout{ grid-template-columns: 1fr; }
    #listingsMap{ min-height:340px; }
  }
  @media (max-width: 980px){
    .layout{grid-template-columns: 1fr; gap:18px}
    .sidebar{order:2}
    .legend{position:static; margin-bottom:10px}
    .filters{flex-wrap:wrap;}
  }
</style>
</head>
<body>
  <header class="brandbar" role="banner">
    <div class="brandwrap">
      <img id="treLogo" class="brand-logo" src="tre-logo.png" alt="Texas Relocation Experts logo" onerror="this.classList.add('hide');document.querySelector('.brand-text').classList.remove('hide');">
      <div class="brand-text hide">Texas Relocation Experts</div>
    </div>
    <div class="brandspacer"></div>
    <div class="envbadge">Manager View</div>
  </header>

  <div class="layout">
    <aside class="sidebar" aria-label="App sections">
      <ul class="nav" id="nav">
        <li class="active" data-section="leads">LEADS</li>
        <li data-section="tasks">TASKS</li>
        <li data-section="agents">AGENTS</li>
        <li data-section="listings">LISTINGS</li>
      </ul>
    </aside>

    <!-- ================== LEADS SECTION ================== -->
    <section id="leadsSection" class="panel" aria-labelledby="leadsTitle">
      <div class="legend" aria-label="Lead Health Legend">
        <span class="legend-item" title="Healthy (Green)"><span class="dot green"></span></span>
        <span class="legend-item" title="Warm (Yellow)"><span class="dot yellow"></span></span>
        <span class="legend-item" title="At Risk (Red)"><span class="dot red"></span></span>
        <span class="legend-item" title="Closed â€” Lead won"><span class="health-icon health-check"><svg viewBox="0 0 24 24"><path d="M5 13l4 4 10-10"/></svg></span></span>
        <span class="legend-item" title="Lost â€” Lead did not convert"><span class="health-icon health-lost"><svg viewBox="0 0 24 24"><path d="M6 6l12 12M18 6L6 18"/></svg></span></span>
        <span class="desc">Lead Health Status</span>
      </div>

      <h1 id="leadsTitle" class="sr-only">Leads</h1>

      <!-- Filters -->
      <div class="filters" id="filters">
        <div class="field"><label for="search">Search</label><input id="search" type="text" placeholder="Name or preferences"></div>
        <div class="field"><label for="statusFilter">Status</label><select id="statusFilter"><option value="all">All</option><option value="green">Healthy</option><option value="yellow">Warm</option><option value="red">At Risk</option><option value="closed">Closed</option><option value="lost">Lost</option></select></div>
        <div class="field"><label for="fromDate">From</label><input id="fromDate" type="date"></div>
        <div class="field"><label for="toDate">To</label><input id="toDate" type="date"></div>
        <div class="spacer"></div><button class="btn" id="clearFilters">Clear</button>
      </div>

      <table class="datagrid" role="grid">
        <colgroup>
          <col class="col-name"><col class="col-view"><col class="col-health"><col class="col-date"><col class="col-summary"><col class="col-options"><col class="col-action"><col class="col-assign">
        </colgroup>
        <thead>
          <tr>
            <th class="col-name">Lead Name</th>
            <th class="col-view">View Details</th>
            <th class="sr-only col-health">Health</th>
            <th class="col-date">LeadFoundDate</th>
            <th class="col-summary">Preference Summary</th>
            <th class="col-options">Top Listing Options</th>
            <th class="col-action">Action</th>
            <th class="col-assign">Agent Assigned</th>
          </tr>
        </thead>
        <tbody id="leadRows"></tbody>
      </table>
    </section>

    <!-- ================== AGENTS SECTION ================== -->
    <section id="agentsSection" class="panel hidden" aria-labelledby="agentsTitle">
      <h1 id="agentsTitle" class="sr-only">Agents</h1>
      <div class="filters" id="agentFilters">
        <div class="field"><label for="agentSearch">Search</label><input id="agentSearch" type="text" placeholder="Agent name"></div>
        <div class="spacer"></div><button class="btn" id="agentClear">Clear</button>
      </div>

      <table class="datagrid" role="grid">
        <colgroup>
          <col class="col-name"><col class="col-view"><col class="col-num"><col class="col-num"><col class="col-num"><col class="col-money"><col class="col-money">
        </colgroup>
        <thead>
          <tr>
            <th>Agent Name</th><th>View Details</th><th># Leads Assigned</th><th># Leads Gained (30d)</th><th># Leads Closed (90d)</th><th>Sales Total</th><th>Commission Earned</th>
          </tr>
        </thead>
        <tbody id="agentRows"></tbody>
      </table>
    </section>

    <!-- ================== LISTINGS SECTION ================== -->
    <section id="listingsSection" class="panel hidden" aria-labelledby="listingsTitleH">
      <h1 id="listingsTitleH" class="sr-only">Listings</h1>

      <div class="filters">
        <div class="field"><label for="lsSearch">Search</label><input id="lsSearch" type="text" placeholder="Search by name or area"></div>
        <div class="field"><label for="lsArea">Location/Area</label><select id="lsArea"><option value="all">All Areas</option><option>San Antonio</option><option>New Braunfels</option><option>Leon Valley</option></select></div>
        <div class="field"><label for="lsMin">Min Price</label><input id="lsMin" type="text" placeholder="e.g., 1000"></div>
        <div class="field"><label for="lsMax">Max Price</label><input id="lsMax" type="text" placeholder="e.g., 1300"></div>
        <div class="field"><label for="lsBeds">Bed/Bath</label><select id="lsBeds"><option value="any">Any</option><option value="0">Studio</option><option value="1">1+</option><option value="2">2+</option><option value="3">3+</option></select></div>
        <div class="field"><label for="lsAmen">Amenities</label><select id="lsAmen"><option value="any">Any</option><option value="ev">EV Charging</option><option value="pet">Pet Friendly</option></select></div>
        <div class="spacer"></div><button class="btn" id="lsClear">Clear Filters</button>
      </div>

      <div class="listings-layout">
        <div class="results">
          <div class="table-scroller">
            <table class="listing-table">
              <thead><tr><th>Property</th><th>Address</th><th>Price</th><th>Beds</th><th>Baths</th><th>SqFt</th><th>Perks</th></tr></thead>
              <tbody id="listingRows"></tbody>
            </table>
          </div>
        </div>
        <div class="mapwrap"><div id="listingsMap" aria-label="Map of properties"></div></div>
      </div>
      <div class="muted" style="margin-top:8px;">Map: OpenStreetMap via Leaflet.</div>
    </section>

    <!-- ================== COMING SECTION (for TASKS) ================== -->
    <section id="comingSection" class="panel hidden" aria-live="polite">
      <div class="coming"><h2 id="comingTitle">Coming Soon</h2><p>Weâ€™re building this screen now. Check back shortly.</p></div>
    </section>
  </div>

  <!-- ---------- LEAD Details Modal ---------- -->
  <div id="detailsModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="detailsTitle">
    <div class="modal-box" role="document">
      <div class="modal-header"><div class="title" id="detailsTitle">Apartment Inquiry â€” <span id="leadNameTitle">Lead</span></div><button class="modal-close" data-close="detailsModal" aria-label="Close details">âœ•</button></div>
      <div class="modal-body">
        <p style="margin:0 0 6px;color:#374151">Your agent is <strong>Gilbert Costello</strong>.</p>
        <div class="grid cols-3">
          <div><label>First Name</label><input id="ldFirst" type="text" value="Testy" readonly></div>
          <div><label>Last Name</label><input id="ldLast" type="text" value="Testor" readonly></div>
          <div><label>Phone</label><input id="ldPhone" type="tel" value="(312) 555-0198" readonly></div>
          <div><label>Email</label><input id="ldEmail" type="email" value="testy.testor@example.com" readonly></div>
          <div><label>Where did you hear about us?</label><input type="text" value="Friend referral" readonly></div>
        </div>
        <div class="grid cols-3" style="margin-top:12px;">
          <div><label>Market</label><input type="text" value="Chicago" readonly></div>
          <div><label>Neighborhoods</label><input type="text" value="Lincoln Park, Wicker Park" readonly></div>
          <div><label>Move-in Date</label><input type="text" value="Earliest: 11/15, Latest: 12/10" readonly></div>
          <div><label>Lease Term (months)</label><input type="text" value="12" readonly></div>
          <div><label>Number of Pets</label><input type="text" value="1" readonly></div>
          <div><label>Pet Type</label><input type="text" value="Small dog" readonly></div>
          <div><label>Parking Spaces</label><input type="text" value="1" readonly></div>
          <div><label>Open to Parking</label><input type="text" value="Street or Garage" readonly></div>
          <div><label>Square Feet</label><input type="text" value="700â€“900 (flexible)" readonly></div>
          <div><label>Price</label><input type="text" value="$1,000 â€“ $1,250 / mo" readonly></div>
          <div><label>Bedrooms</label><input type="text" value="2 Bed preferred (3 OK)" readonly></div>
          <div><label>Bathrooms</label><input type="text" value="1.5+ Bath" readonly></div>
        </div>
        <div style="margin-top:12px;"><label>Notes</label><textarea readonly>Quiet building preferred. Close to L train. OK with older finishes if price is right.</textarea></div>
      </div>
    </div>
  </div>

  <!-- ---------- Generic Action Modal ---------- -->
  <div id="actionModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="actionTitle">
    <div class="modal-box" role="document">
      <div class="modal-header"><div class="title" id="actionTitle">Action</div><button class="modal-close" data-close="actionModal" aria-label="Close action">âœ•</button></div>
      <div class="modal-body" id="actionBody"></div>
    </div>
  </div>

  <!-- ---------- LISTING Options Modal (from Leads) ---------- -->
  <div id="listingsModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="listingsTitle">
    <div class="modal-box" role="document">
      <div class="modal-header"><div class="title" id="listingsTitle">Top Listing Options â€” <span id="leadNameTitle2">Lead</span></div><button class="modal-close" data-close="listingsModal" aria-label="Close listing options">âœ•</button></div>
      <div style="position:sticky; top:0; background:#f8fbff; padding:12px 14px; border-bottom:1px solid var(--rule); display:flex; align-items:center; gap:10px; justify-content:space-between;">
        <button id="sendBtn" class="doc-btn" style="background:var(--brand);color:#fff;border-color:var(--brand)" disabled>Send options to Lead: <span id="sendLeadName">Lead</span></button>
        <div class="muted"><span id="selectedCount">0</span> selected</div>
      </div>
      <div class="modal-body"><div id="listingsGrid" style="display:grid; grid-template-columns: repeat(auto-fill,minmax(260px,1fr)); gap:14px;"></div></div>
    </div>
  </div>

  <!-- ---------- Agent Details Modal ---------- -->
  <div id="agentModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="agentTitle">
    <div class="modal-box" role="document">
      <div class="modal-header"><div class="title" id="agentTitle">Agent â€” <span id="agentNameTitle">Name</span></div><button class="modal-close" data-close="agentModal" aria-label="Close agent details">âœ•</button></div>
      <div class="modal-body">
        <div class="grid cols-3">
          <div><label>Last Login</label><input id="agLastLogin" type="text" readonly></div>
          <div><label>Time Employed with TRE</label><input id="agTenure" type="text" readonly></div>
          <div><label>Leads Currently Assigned</label><input id="agLeadCount" type="text" readonly></div>
        </div>
        <div class="form-section"><h3>Latest Actions</h3><ul id="agActions" style="margin:0; padding-left:18px;"></ul></div>
        <div class="form-section"><h3>Current Leads Assigned</h3><div id="agLeads" class="pills"></div></div>
      </div>
    </div>
  </div>

  <div id="snackbar" class="snackbar" role="status" aria-live="polite">Action completed.</div>
  <div id="healthPopover" class="popover" style="display:none"><div class="arrow"></div><h4 id="popTitle">Lead Status</h4><ul id="popList"></ul><div class="small">Click anywhere to dismiss</div></div>
  <div id="actionMenu" class="menu" role="menu" aria-label="Lead actions" aria-hidden="true">
    <button data-action="guestcard">Send Guest Card</button>
    <button data-action="lease">Send Lease Agreement for Signature</button>
    <button data-action="relocation">Send Relocation Form</button>
    <button data-action="lost" class="danger">Mark Lead as Lost</button>
  </div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
/* ========== NAVIGATION ========== */
const nav = document.getElementById('nav');
const leadsSection = document.getElementById('leadsSection');
const agentsSection = document.getElementById('agentsSection');
const listingsSection = document.getElementById('listingsSection');
const comingSection = document.getElementById('comingSection');
const comingTitle = document.getElementById('comingTitle');

nav.addEventListener('click', (e) => {
  const li = e.target.closest('li'); if(!li) return;
  document.querySelectorAll('.nav li').forEach(n => n.classList.remove('active')); li.classList.add('active');
  const section = li.dataset.section;
  leadsSection.classList.add('hidden'); agentsSection.classList.add('hidden'); listingsSection.classList.add('hidden'); comingSection.classList.add('hidden');
  if(section === 'leads'){ leadsSection.classList.remove('hidden'); }
  else if(section === 'agents'){ agentsSection.classList.remove('hidden'); }
  else if(section === 'listings'){ listingsSection.classList.remove('hidden'); ensureMap(); }
  else { comingSection.classList.remove('hidden'); comingTitle.textContent = section.toUpperCase() + ' â€” Coming Soon'; }
});

/* ========== LEADS DATA & RENDER ========== */
const LEADS = [
  {id:1, name:'Alex Morgan', status:'green', date:'2025-10-01', prefs:'2bed/2bath <$1200/mo', email:'alex@example.com', phone:'(312) 555-1001', assignedAgent:'Gilbert Costello', currentStatus:'Listing Sent for Review'},
  {id:2, name:'Dana Lee', status:'yellow', date:'2025-09-30', prefs:'1bed/1bath <$1000/mo', email:'dana@example.com', phone:'(312) 555-1002', assignedAgent:'Ava Thompson', currentStatus:'Scheduling Pending'},
  {id:3, name:'Jordan Patel', status:'red', date:'2025-09-28', prefs:'3bed/2bath <$1300/mo', email:'jordan@example.com', phone:'(312) 555-1003', assignedAgent:'Marcus Young', currentStatus:'Guest Card Sent'},
  {id:4, name:'Chris Nguyen', status:'red', date:'2025-09-26', prefs:'2bed/1.5bath <$1100/mo', email:'chris@example.com', phone:'(312) 555-1004', assignedAgent:'Gilbert Costello', currentStatus:'Scheduling Pending'},
  {id:5, name:'Taylor Brooks', status:'green', date:'2025-10-02', prefs:'2bed/2bath <$1200/mo', email:'taylor@example.com', phone:'(312) 555-1005', assignedAgent:'Ava Thompson', currentStatus:'Listing Sent for Review'},
  {id:6, name:'Priya Shah', status:'yellow', date:'2025-09-29', prefs:'Studio/1bath <$900/mo', email:'priya@example.com', phone:'(312) 555-1006', assignedAgent:'Gilbert Costello', currentStatus:'Guest Card Sent'},
  {id:7, name:'Sam Carter', status:'lost', date:'2025-09-22', prefs:'1bed/1bath <$1050/mo', email:'sam@example.com', phone:'(312) 555-1007', assignedAgent:'Marcus Young', currentStatus:'Lead Lost'},
  {id:8, name:'Morgan Reed', status:'closed', date:'2025-09-25', prefs:'2bed/2bath <$1250/mo', email:'morgan@example.com', phone:'(312) 555-1008', assignedAgent:'Ava Thompson', currentStatus:'Closed'},
  {id:9, name:'Jamie Chen', status:'red', date:'2025-10-01', prefs:'3bed/3bath <$1400/mo', email:'jamie@example.com', phone:'(312) 555-1009', assignedAgent:'Marcus Young', currentStatus:'Scheduling Pending'},
  {id:10, name:'Riley Adams', status:'yellow', date:'2025-09-27', prefs:'2bed/2bath <$1200/mo', email:'riley@example.com', phone:'(312) 555-1010', assignedAgent:'Gilbert Costello', currentStatus:'Listing Sent for Review'},
  {id:11, name:'Cameron Ortiz', status:'green', date:'2025-09-23', prefs:'2bed/2bath <$1150/mo', email:'cameron@example.com', phone:'(312) 555-1011', assignedAgent:'Ava Thompson', currentStatus:'Guest Card Sent'},
  {id:12, name:'Casey Kim', status:'closed', date:'2025-10-03', prefs:'1bed/1bath <$1000/mo', email:'casey@example.com', phone:'(312) 555-1012', assignedAgent:'Gilbert Costello', currentStatus:'Closed'},
  {id:13, name:'Ariana Gomez', status:'lost', date:'2025-09-21', prefs:'3bed/2bath <$1350/mo', email:'ariana@example.com', phone:'(312) 555-1013', assignedAgent:'Ava Thompson', currentStatus:'Lead Lost'},
  {id:14, name:'Noah Wallace', status:'green', date:'2025-09-24', prefs:'2bed/2bath <$1250/mo', email:'noah@example.com', phone:'(312) 555-1014', assignedAgent:'Marcus Young', currentStatus:'Listing Sent for Review'},
  {id:15, name:'Owen Price', status:'yellow', date:'2025-10-01', prefs:'Studio/1bath <$950/mo', email:'owen@example.com', phone:'(312) 555-1015', assignedAgent:'Gilbert Costello', currentStatus:'Scheduling Pending'},
  {id:16, name:'Quinn Bailey', status:'red', date:'2025-09-30', prefs:'2bed/1bath <$1100/mo', email:'quinn@example.com', phone:'(312) 555-1016', assignedAgent:'Ava Thompson', currentStatus:'Guest Card Sent'}
];
const STATUS_LABEL = { green:'Healthy', yellow:'Warm', red:'At Risk', closed:'Closed', lost:'Lost' };
function formatDate(iso){ const d = new Date(iso+'T00:00:00'); return `${d.getMonth()+1}/${d.getDate()}/${String(d.getFullYear()).slice(-2)}`; }

const filters = { search:'', status:'all', from:'', to:'' };
['search','statusFilter','fromDate','toDate'].forEach(id => {
  const el = document.getElementById(id);
  el && el.addEventListener(id==='statusFilter'?'change':'input', e => {
    const key = id==='search'?'search':id==='statusFilter'?'status':id==='fromDate'?'from':'to';
    filters[key] = e.target.value.toLowerCase?.() ? e.target.value.toLowerCase().trim() : e.target.value; renderLeadRows();
  });
});
document.getElementById('clearFilters').addEventListener('click', ()=>{
  filters.search=''; filters.status='all'; filters.from=''; filters.to='';
  ['search','statusFilter','fromDate','toDate'].forEach(id => document.getElementById(id).value = id==='statusFilter'?'all':''); renderLeadRows();
});
function withinRange(date, from, to){ if(from && date < from) return false; if(to && date > to) return false; return true; }

const leadRows = document.getElementById('leadRows');
function healthCell(status){
  if(status === 'green'){ return `<button class="health-btn" data-status="green" aria-label="Healthy"><span class="health-dot health-green"></span></button>`; }
  if(status === 'yellow'){ return `<button class="health-btn" data-status="yellow" aria-label="Warm"><span class="health-dot health-yellow"></span></button>`; }
  if(status === 'red'){ return `<button class="health-btn" data-status="red" aria-label="At Risk"><span class="health-dot health-red"></span></button>`; }
  if(status === 'closed'){ return `<button class="health-btn" data-status="closed" aria-label="Closed"><span class="health-icon health-check"><svg viewBox="0 0 24 24"><path d="M5 13l4 4 10-10"/></svg></span></button>`; }
  return `<button class="health-btn" data-status="lost" aria-label="Lost"><span class="health-icon health-lost"><svg viewBox="0 0 24 24"><path d="M6 6l12 12M18 6L6 18"/></svg></span></button>`;
}
function actionCell(leadId){ return `<button class="action-btn" aria-haspopup="menu" aria-expanded="false" data-lead="${leadId}" title="Actions">â‹®</button>`; }
function renderLeadRows(){
  const list = LEADS
    .filter(l => filters.status==='all' ? true : l.status===filters.status)
    .filter(l => filters.search ? (l.name.toLowerCase().includes(filters.search) || l.prefs.toLowerCase().includes(filters.search)) : true)
    .filter(l => withinRange(l.date, filters.from, filters.to));
  leadRows.innerHTML = '';
  list.forEach(l => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="col-name">${l.name}</td>
      <td class="col-view"><button class="eye-btn view-details" data-lead="${l.name}" aria-label="View details"><svg class="eye" viewBox="0 0 24 24" fill="none" stroke="#111" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5c5.5 0 9.5 4.5 9.5 7s-4 7-9.5 7S2.5 14.5 2.5 12 6.5 5 12 5Z"/><circle cx="12" cy="12" r="3.2" fill="#111"/></svg></button></td>
      <td class="col-health">${healthCell(l.status)}</td>
      <td class="col-date">${formatDate(l.date)}</td>
      <td class="col-summary">${l.prefs}</td>
      <td class="col-options"><button class="doc-btn list-options" data-lead="${l.name}" aria-label="Top listing options"><svg class="doc" viewBox="0 0 24 24" fill="none" stroke="#111" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="3.5" width="12" height="17" rx="2.2"/><line x1="9" y1="8" x2="15" y2="8"/><line x1="9" y1="12" x2="15" y2="12"/><line x1="9" y1="16" x2="15" y2="16"/></svg></button></td>
      <td class="col-action">${actionCell(l.id)}</td>
      <td class="col-assign"><div class="assign"><input type="text" aria-label="Assign an agent" value="${l.assignedAgent}"><span class="caret"></span></div></td>`;
    leadRows.appendChild(tr);
  });
}
renderLeadRows();

/* LEAD modals */
function openModal(id){ const m = document.getElementById(id); m.classList.add('open'); m.setAttribute('aria-hidden','false'); trapFocus(id); }
function closeModal(id){ const m = document.getElementById(id); m.classList.remove('open'); m.setAttribute('aria-hidden','true'); untrapFocus(id); }
document.querySelectorAll('.modal-close').forEach(btn => btn.addEventListener('click', ()=> closeModal(btn.dataset.close)));
document.querySelectorAll('.modal').forEach(m => m.addEventListener('click', (e)=>{ if(e.target === m) closeModal(m.id); }));
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ document.querySelectorAll('.modal.open').forEach(m => closeModal(m.id)); hidePopover(); hideMenu(); } });

document.addEventListener('click', (e) => {
  const vd = e.target.closest('.view-details');
  if(vd){ document.getElementById('leadNameTitle').textContent = vd.dataset.lead || 'Lead'; openModal('detailsModal'); }
  const lo = e.target.closest('.list-options');
  if(lo){
    const leadName = lo.dataset.lead || 'Lead';
    document.getElementById('leadNameTitle2').textContent = leadName;
    document.getElementById('sendLeadName').textContent = leadName;
    openModal('listingsModal'); updateSelectionSummary();
  }
});

/* Listing options grid (used in Leads modal) */
const listings = [
  { id:'l1', name:'Parkview Lofts â€¢ 1010 N Clark St', price:1150, beds:2, baths:2, sqft:820, referral:'$350', notes:'Walk to L, pets ok.'},
  { id:'l2', name:'Riverview Flats â€¢ 2333 W Belmont Ave', price:1195, beds:3, baths:2, sqft:960, referral:'$500', notes:'Garage parking + EV chargers.'},
  { id:'l3', name:'The Maple â€¢ 77 W Maple St', price:1090, beds:2, baths:1.5, sqft:780, referral:'$250', notes:'Rooftop deck & gym.'},
  { id:'l4', name:'Lakefront Commons â€¢ 400 E Erie St', price:1250, beds:2, baths:2, sqft:900, referral:'$400', notes:'Doorman, elevator, pkg extra.'},
  { id:'l5', name:'Wicker Yard â€¢ 1675 N Milwaukee Ave', price:1125, beds:2, baths:2, sqft:840, referral:'$300', notes:'Dog run, close to 606 trail.'},
  { id:'l6', name:'Armitage Row â€¢ 1450 W Armitage Ave', price:1180, beds:3, baths:2, sqft:930, referral:'$450', notes:'Inâ€‘unit W/D, near Metra.'}
];
const listingsGrid = document.getElementById('listingsGrid');
function renderListingCards(){
  listingsGrid.innerHTML = '';
  listings.forEach(x => {
    const el = document.createElement('article');
    el.style.border='1px solid var(--rule)'; el.style.borderRadius='12px'; el.style.overflow='hidden'; el.style.background='#fff';
    el.innerHTML = `
      <div style="background: repeating-linear-gradient(45deg, #f3f4f6, #f3f4f6 10px, #e5e7eb 10px, #e5e7eb 20px); height:140px; display:flex; align-items:center; justify-content:center; color:#6b7280; font-weight:700;">Image Placeholder</div>
      <div style="padding:12px; display:grid; gap:8px;">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
          <div style="font-weight:800">${x.name}</div>
          <div class="tag" title="Referral Offering">Referral: ${x.referral}</div>
        </div>
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
          <div style="font-weight:900; font-size:18px;">$${x.price.toLocaleString()}/mo</div>
          <div style="color:#374151; font-size:14px;">${x.beds} bd â€¢ ${x.baths} ba â€¢ ${x.sqft} sqft</div>
        </div>
        <div style="color:#374151; font-size:14px;">${x.notes}</div>
        <div style="display:flex; align-items:center; justify-content:space-between; border-top:1px dashed var(--rule); padding-top:8px;">
          <label><input type="checkbox" class="listing-check" data-id="${x.id}"> Select</label>
          <button class="doc-btn" title="View more (placeholder)" style="height:32px">â‹¯</button>
        </div>
      </div>`;
    listingsGrid.appendChild(el);
  });
}
renderListingCards();

const sendBtn = document.getElementById('sendBtn');
const selectedCount = document.getElementById('selectedCount');
function updateSelectionSummary(){ const ck = [...document.querySelectorAll('.listing-check')].filter(c => c.checked); selectedCount.textContent = ck.length; sendBtn.disabled = ck.length === 0; }
document.addEventListener('change', (e)=>{ if(e.target.classList && e.target.classList.contains('listing-check')) updateSelectionSummary(); });
sendBtn.addEventListener('click', ()=>{ const selected = [...document.querySelectorAll('.listing-check')].filter(c => c.checked).map(c => c.dataset.id); closeModal('listingsModal'); showSnack(`Sent ${selected.length} listing(s) to ${document.getElementById('sendLeadName').textContent}.`); });

/* Snackbar */
function showSnack(text){ const bar=document.getElementById('snackbar'); bar.textContent=text; bar.classList.add('show'); setTimeout(()=>bar.classList.remove('show'),2200); }

/* Health popover */
const healthMessages = {
  red: ['- Lead has not been provided listing options.','- Lease Agreement has been pending e-signature for 2d 4h.'],
  yellow: ['- Lead has not responded in 3d 10h.','- Lead is not scheduled to visit Riverview Flats yet.'],
  green: ['- Lead signed off, awaiting Lease Agreement signoff.'],
  closed: ['Lead Closed!'],
  lost: ['Lead Lost.']
};
const pop = document.getElementById('healthPopover');
const popTitle = document.getElementById('popTitle');
const popList = document.getElementById('popList');
function showPopover(anchor, status){
  popTitle.textContent = `Status â€” ${STATUS_LABEL[status] || status}`;
  popList.innerHTML = healthMessages[status].map(s => `<li>${s}</li>`).join('');
  const r = anchor.getBoundingClientRect();
  let top = r.bottom + 10; let left = r.left - 12;
  if(left + 300 > window.innerWidth) left = window.innerWidth - 310;
  if(left < 8) left = 8;
  pop.style.top = `${Math.round(top)}px`; pop.style.left = `${Math.round(left)}px`; pop.style.display = 'block';
}
function hidePopover(){ pop.style.display='none'; }
document.addEventListener('mouseenter', (e)=>{ const btn = e.target.closest('.health-btn'); if(!btn) return; showPopover(btn, btn.dataset.status); }, true);
document.addEventListener('mouseleave', (e)=>{ if(e.target.closest && e.target.closest('.health-btn')) setTimeout(()=>{ if(!pop.matches(':hover')) hidePopover(); }, 150); }, true);
document.addEventListener('click', (e)=>{ const btn=e.target.closest('.health-btn'); if(btn){ const open = pop.style.display==='block'; if(open) hidePopover(); else showPopover(btn, btn.dataset.status); e.stopPropagation(); } });
window.addEventListener('resize', hidePopover); window.addEventListener('scroll', ()=>{ if(pop.style.display==='block') hidePopover(); }, true);

/* ========== AGENTS PAGE ========== */
const AGENTS = [
  { id:1, name:'Gilbert Costello', lastLogin:'2025-10-03T14:10:00', employedSince:'2022-06-15', leadsAssigned:12, gained30:18, closed90:9, sales:152000, commission:15200,
    actions:['Sent 3 listings to Dana Lee','Closed lease with Casey Kim','Followed up with Jordan Patel'],
    currentLeads:['Alex Morgan','Jordan Patel','Taylor Brooks','Riley Adams'] },
  { id:2, name:'Ava Thompson', lastLogin:'2025-10-04T09:05:00', employedSince:'2023-02-01', leadsAssigned:9, gained30:12, closed90:6, sales:99000, commission:9900,
    actions:['Scheduled 2 tours for Morgan Reed','New lead from referral','Updated listing notes for Riverview Flats'],
    currentLeads:['Morgan Reed','Noah Wallace','Owen Price'] },
  { id:3, name:'Marcus Young', lastLogin:'2025-10-02T19:20:00', employedSince:'2021-09-10', leadsAssigned:15, gained30:20, closed90:11, sales:184500, commission:18450,
    actions:['Created 4 new listing options','Reviewed lease for Taylor Brooks','Call with landlordâ€”discount approved'],
    currentLeads:['Taylor Brooks','Jamie Chen','Chris Nguyen','Quinn Bailey'] }
];
const agentRows = document.getElementById('agentRows');
const agentSearch = document.getElementById('agentSearch');
function money(x){ return '$' + x.toLocaleString(); }
function renderAgentRows(){
  const term = (agentSearch.value||'').toLowerCase();
  agentRows.innerHTML = '';
  AGENTS.filter(a => a.name.toLowerCase().includes(term)).forEach(a => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="col-name">${a.name}</td>
      <td class="col-view"><button class="eye-btn agent-details" data-id="${a.id}" aria-label="View agent details"><svg class="eye" viewBox="0 0 24 24" fill="none" stroke="#111" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5c5.5 0 9.5 4.5 9.5 7s-4 7-9.5 7S2.5 14.5 2.5 12 6.5 5 12 5Z"/><circle cx="12" cy="12" r="3.2" fill="#111"/></svg></button></td>
      <td class="col-num">${a.leadsAssigned}</td>
      <td class="col-num">${a.gained30}</td>
      <td class="col-num">${a.closed90}</td>
      <td class="col-money">${money(a.sales)}</td>
      <td class="col-money">${money(a.commission)}</td>`;
    agentRows.appendChild(tr);
  });
}
agentSearch.addEventListener('input', renderAgentRows);
document.getElementById('agentClear').addEventListener('click', ()=>{ agentSearch.value=''; renderAgentRows(); });
renderAgentRows();

function humanizeTenure(iso){
  const start = new Date(iso), now = new Date();
  let months = (now.getFullYear()-start.getFullYear())*12 + (now.getMonth()-start.getMonth());
  if(now.getDate()<start.getDate()) months -= 1;
  const years = Math.floor(months/12), mos = months%12;
  return `${years?years+'y ':''}${mos?mos+'m':''}`.trim() || '0m';
}
function fmtDateTime(iso){
  const d = new Date(iso); return d.toLocaleString([], {year:'numeric', month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit'});
}
document.addEventListener('click', (e)=>{
  const btn = e.target.closest('.agent-details'); if(!btn) return;
  const a = AGENTS.find(x => x.id==btn.dataset.id); if(!a) return;
  document.getElementById('agentNameTitle').textContent = a.name;
  document.getElementById('agLastLogin').value = fmtDateTime(a.lastLogin);
  document.getElementById('agTenure').value = humanizeTenure(a.employedSince);
  document.getElementById('agLeadCount').value = a.leadsAssigned;
  const ul = document.getElementById('agActions'); ul.innerHTML = a.actions.map(x=>`<li>${x}</li>`).join('');
  const pills = document.getElementById('agLeads'); pills.innerHTML = a.currentLeads.map(n=>`<span class="badge">${n}</span>`).join('');
  openModal('agentModal');
});

/* ========== LISTINGS PAGE ========== */
const PROPS = [
  { id:'p1', name:'Oasis at Stone Oak', address:'23609 Canyon Golf, San Antonio, TX', area:'San Antonio', price:1215, beds:1, baths:1, sqft:715, perks:['2 Months Free','App + Admin Fee'], ev:true, pet:true, lat:29.651, lng:-98.494 },
  { id:'p2', name:'Alamo Luxury Rental Homes', address:'13003 Toepperwein Rd #601, Live Oak, TX', area:'San Antonio', price:1200, beds:2, baths:2, sqft:980, perks:['8 Weeks Free'], ev:false, pet:true, lat:29.557, lng:-98.354 },
  { id:'p3', name:'Ascend on Potranco', address:'14690 Potranco Rd, San Antonio, TX', area:'San Antonio', price:1045, beds:1, baths:1, sqft:680, perks:['Up to 8 Weeks Free'], ev:true, pet:true, lat:29.460, lng:-98.766 },
  { id:'p4', name:'Solstice Springs Townhomes', address:'2997 Rosenberg St, New Braunfels, TX', area:'New Braunfels', price:1295, beds:3, baths:2, sqft:1180, perks:['4 Weeks Free','Waived Admin Fee','Application Fees Credited'], ev:false, pet:true, lat:29.707, lng:-98.125 },
  { id:'p5', name:'The Oaks of Leon Valley', address:'7000 Evers Rd, Leon Valley, TX', area:'Leon Valley', price:1099, beds:2, baths:2, sqft:920, perks:['Newly Renovated'], ev:true, pet:false, lat:29.490, lng:-98.618 },
  { id:'p6', name:'River Bend Flats', address:'455 River Bend Dr, San Antonio, TX', area:'San Antonio', price:1010, beds:0, baths:1, sqft:540, perks:['Move-in Special $500 Off'], ev:false, pet:true, lat:29.450, lng:-98.480 }
];

const listingRows = document.getElementById('listingRows');
const lsSearch = document.getElementById('lsSearch');
const lsArea = document.getElementById('lsArea');
const lsMin = document.getElementById('lsMin');
const lsMax = document.getElementById('lsMax');
const lsBeds = document.getElementById('lsBeds');
const lsAmen = document.getElementById('lsAmen');

function parseMoney(v){ const n = parseInt(String(v).replace(/[^0-9]/g,'')); return isNaN(n)?null:n; }
document.getElementById('lsClear').addEventListener('click', ()=>{ lsSearch.value=''; lsArea.value='all'; lsMin.value=''; lsMax.value=''; lsBeds.value='any'; lsAmen.value='any'; renderListingRows(); });
[lsSearch, lsArea, lsMin, lsMax, lsBeds, lsAmen].forEach(el => el.addEventListener('input', renderListingRows));
[lsArea, lsBeds, lsAmen].forEach(el => el.addEventListener('change', renderListingRows));

let map, markers=[];
function ensureMap(){ if(map) { setTimeout(()=> map.invalidateSize(), 60); return; } map = L.map('listingsMap', { zoomControl:true }).setView([29.48,-98.50], 10); L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map); renderListingRows(); }
function clearMarkers(){ markers.forEach(m=>m.remove()); markers=[]; }
function addMarker(p){ const icon = L.divIcon({ html:`<div class="price-marker">$${p.price.toLocaleString()}</div>`, className:'', iconSize:[0,0] }); const m = L.marker([p.lat,p.lng], { icon }).addTo(map); m.bindPopup(`<strong>${p.name}</strong><br>${p.address}<br><span class="muted">$${p.price.toLocaleString()} &middot; ${p.beds} bd / ${p.baths} ba</span>`); markers.push(m); }
function renderListingRows(){
  const term = lsSearch.value.trim().toLowerCase(); const area = lsArea.value; const min = parseMoney(lsMin.value); const max = parseMoney(lsMax.value); const beds = lsBeds.value; const amen = lsAmen.value;
  const filtered = PROPS.filter(p => {
    if(area !== 'all' && p.area !== area) return false;
    if(term && !(p.name.toLowerCase().includes(term) || p.address.toLowerCase().includes(term) || p.area.toLowerCase().includes(term))) return false;
    if(min !== null && p.price < min) return false; if(max !== null && p.price > max) return false;
    if(beds !== 'any'){ const b = parseInt(beds); if(!isNaN(b) && p.beds < b) return false; }
    if(amen === 'ev' && !p.ev) return false; if(amen === 'pet' && !p.pet) return false; return true;
  });
  listingRows.innerHTML = ''; filtered.forEach(p => { const tr = document.createElement('tr'); const perks = p.perks.map(x=>`<span class="badge">${x}</span>`).join(''); tr.innerHTML = `<td><strong>${p.name}</strong></td><td>${p.address}</td><td>$${p.price.toLocaleString()}</td><td>${p.beds}</td><td>${p.baths}</td><td>${p.sqft}</td><td>${perks}</td>`; listingRows.appendChild(tr); });
  if(!map) return; clearMarkers(); if(filtered.length === 0){ return; } const bounds = []; filtered.forEach(p => { addMarker(p); bounds.push([p.lat,p.lng]); }); if(bounds.length) map.fitBounds(bounds, { padding:[30,30] });
}

/* ========== ACTION MENU (both views) ========== */
const actionMenu = document.getElementById('actionMenu');
let actionContext = { leadId:null };
function hideMenu(){ actionMenu.classList.remove('open'); actionMenu.setAttribute('aria-hidden','true'); document.querySelectorAll('.action-btn[aria-expanded="true"]').forEach(b=>b.setAttribute('aria-expanded','false')); }
function showMenu(anchor, leadId){
  const r = anchor.getBoundingClientRect();
  actionMenu.style.top = (r.bottom + 8) + 'px';
  actionMenu.style.left = Math.min(window.innerWidth-280, r.left - 200 + r.width) + 'px';
  actionMenu.classList.add('open');
  actionMenu.setAttribute('aria-hidden','false');
  actionContext.leadId = leadId;
}
document.addEventListener('click', (e)=>{
  const btn = e.target.closest('.action-btn');
  if(btn){ e.stopPropagation(); const open = actionMenu.classList.contains('open'); hideMenu(); if(!open) { showMenu(btn, btn.dataset.lead); btn.setAttribute('aria-expanded','true'); } }
  else if(!e.target.closest('#actionMenu')){ hideMenu(); }
});
actionMenu.addEventListener('click', (e)=>{
  const act = e.target.dataset.action; if(!act) return;
  hideMenu();
  const lead = LEADS.find(l => l.id == actionContext.leadId); if(!lead) return;
  if(act==='lost'){ lead.status='lost'; lead.currentStatus='Lead Lost'; renderLeadRows(); showSnack(`Marked ${lead.name} as Lost.`); return; }
  openActionModal(act, lead);
});

function openActionModal(type, lead){
  const title = { guestcard:'Send Guest Card', lease:'Send Lease Agreement for Signature', relocation:'Send Relocation Form' }[type] || 'Action';
  document.getElementById('actionTitle').textContent = `${title} â€” ${lead.name}`;
  const body = document.getElementById('actionBody');
  if(type==='guestcard'){
    body.innerHTML = `
      <div class="grid cols-2">
        <div><label>Lead Name</label><input type="text" value="${lead.name}" readonly></div>
        <div><label>Lead Email</label><input type="email" value="${lead.email}" readonly></div>
        <div><label>Lead Phone</label><input type="text" value="${lead.phone}" readonly></div>
        <div><label>Listing to Send</label><select id="gcListing">${listings.map(l=>`<option>${l.name}</option>`).join('')}</select></div>
      </div>
      <div style="margin-top:12px;"><label>Message</label><textarea id="gcMsg">Please create a guest card for ${lead.name}. Contact: ${lead.email}, ${lead.phone}.</textarea></div>
      <div style="margin-top:14px; display:flex; gap:10px; justify-content:flex-end;"><button class="doc-btn" id="gcSend" style="background:var(--brand); color:#fff; border-color:var(--brand);">Send Guest Card</button></div>`;
    openModal('actionModal'); document.getElementById('gcSend').onclick = ()=>{ closeModal('actionModal'); showSnack(`Guest Card sent for ${lead.name}.`); lead.currentStatus='Guest Card Sent'; renderLeadRows(); };
  } else if(type==='lease'){
    body.innerHTML = `
      <div class="grid cols-2">
        <div><label>Lead Email</label><input type="email" value="${lead.email}"></div>
        <div><label>Lease Term (months)</label><input type="text" value="12"></div>
        <div><label>Monthly Rent</label><input type="text" value="$1,200"></div>
        <div><label>Signer Name</label><input type="text" value="${lead.name}"></div>
      </div>
      <div style="margin-top:14px; display:flex; gap:10px; justify-content:flex-end;"><button class="doc-btn" id="leaseSend" style="background:var(--brand); color:#fff; border-color:var(--brand);">Send for Signature</button></div>`;
    openModal('actionModal'); document.getElementById('leaseSend').onclick = ()=>{ closeModal('actionModal'); showSnack(`Lease agreement sent to ${lead.email}.`); lead.currentStatus='Lease Sent'; renderLeadRows(); };
  } else if(type==='relocation'){
    body.innerHTML = `
      <div class="grid cols-2">
        <div><label>Lead Name</label><input type="text" value="${lead.name}" readonly></div>
        <div><label>Lead Email</label><input type="email" value="${lead.email}" readonly></div>
        <div><label>Employer (optional)</label><input type="text" placeholder="Company"></div>
        <div><label>Target Move Date</label><input type="text" value="12/05/25"></div>
      </div>
      <div style="margin-top:14px; display:flex; gap:10px; justify-content:flex-end;"><button class="doc-btn" id="relSend" style="background:var(--brand); color:#fff; border-color:var(--brand);">Send Relocation Form</button></div>`;
    openModal('actionModal'); document.getElementById('relSend').onclick = ()=>{ closeModal('actionModal'); showSnack(`Relocation form sent to ${lead.email}.`); lead.currentStatus='Relocation Form Sent'; renderLeadRows(); };
  } else { body.innerHTML = '<p>Unknown action</p>'; openModal('actionModal'); }
}

/* === Focus management helpers === */
let __lastFocus = null;
function trapFocus(modalId){
  const m = document.getElementById(modalId);
  const focusables = m.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
  if(!focusables.length) return;
  const first = focusables[0], last = focusables[focusables.length-1];
  first.focus();
  function keydown(e){ if(e.key !== 'Tab') return; if(e.shiftKey && document.activeElement === first){ last.focus(); e.preventDefault(); } else if(!e.shiftKey && document.activeElement === last){ first.focus(); e.preventDefault(); } }
  m.__trapKeydown = keydown; m.addEventListener('keydown', keydown);
}
function untrapFocus(modalId){ const m = document.getElementById(modalId); if(m.__trapKeydown){ m.removeEventListener('keydown', m.__trapKeydown); delete m.__trapKeydown; } if(__lastFocus){ __lastFocus.focus(); __lastFocus = null; } }
document.addEventListener('click', (e)=>{ const btn = e.target.closest('.action-btn'); if(btn){ document.querySelectorAll('.action-btn[aria-expanded="true"]').forEach(b=>b.setAttribute('aria-expanded','false')); btn.setAttribute('aria-expanded','true'); }});
</script>
</body>
</html>
